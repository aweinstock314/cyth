<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>cyth.cyth_benchmarks &mdash; cyth 1.0.0.dev1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0.0.dev1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="cyth 1.0.0.dev1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">cyth 1.0.0.dev1 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for cyth.cyth_benchmarks</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">#python -c &quot;import cyth, doctest; print(doctest.testmod(cyth.cyth_benchmarks))&quot;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<span class="kn">import</span> <span class="nn">utool</span>
<span class="kn">import</span> <span class="nn">doctest</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">astor</span>
<span class="kn">from</span> <span class="nn">cyth</span> <span class="kn">import</span> <span class="n">cyth_helpers</span>


<div class="viewcode-block" id="get_bench_text_fmt"><a class="viewcode-back" href="../../cyth.html#cyth.cyth_benchmarks.get_bench_text_fmt">[docs]</a><span class="k">def</span> <span class="nf">get_bench_text_fmt</span><span class="p">():</span>
    <span class="n">bench_text_fmt_</span> <span class="o">=</span> <span class="s">r&#39;&#39;&#39;</span>
<span class="s">    &quot; Autogenerated by cyth on {timestamp} &quot;</span>
<span class="s">    #!/usr/bin/env python</span>
<span class="s">    from __future__ import absolute_import, division, print_function</span>
<span class="s">    import timeit</span>
<span class="s">    import textwrap</span>
<span class="s">    import warnings</span>
<span class="s">    import utool</span>
<span class="s">    import six</span>
<span class="s">    warnings.simplefilter(&#39;ignore&#39;, SyntaxWarning)</span>
<span class="s">    warnings.simplefilter(&#39;ignore&#39;, RuntimeWarning)</span>
<span class="s">    print, print_, printDBG, rrr, profile = utool.inject(__name__, &#39;[{py_modname}.bench]&#39;)</span>


<span class="s">    def run_doctest(pyth_call, cyth_call, setup_script):</span>
<span class="s">        setup_globals_py, setup_locals_py = {{}}, {{}}</span>
<span class="s">        setup_globals_cy, setup_locals_cy = {{}}, {{}}</span>
<span class="s">        six.exec_(setup_script, setup_globals_py, setup_locals_py)</span>
<span class="s">        six.exec_(setup_script, setup_globals_cy, setup_locals_cy)</span>
<span class="s">        pyth_result = eval(cyth_call, setup_globals_py, setup_locals_py)</span>
<span class="s">        cyth_result = eval(cyth_call, setup_globals_cy, setup_locals_cy)</span>
<span class="s">        if repr(pyth_result) == repr(cyth_result):</span>
<span class="s">            #print(&#39;</span><span class="si">%r</span><span class="s"> and </span><span class="si">%r</span><span class="s"> have the same result.&#39; % (pyth_call, cyth_call))</span>
<span class="s">            print(&#39;PASS: output is equivalent&#39;)</span>
<span class="s">            #</span><span class="si">%r</span><span class="s"> and </span><span class="si">%r</span><span class="s"> have the same result.&#39; % (pyth_call, cyth_call))</span>
<span class="s">        else:</span>
<span class="s">            print(&#39;&lt;FAILED&gt;&#39;)</span>
<span class="s">            print(&#39;INCONSISTENCY: </span><span class="si">%r</span><span class="s"> has different output than </span><span class="si">%r</span><span class="s">&#39; % (pyth_call, cyth_call))</span>
<span class="s">            print(&#39;___________&#39;)</span>
<span class="s">            print(&#39;pyth_result&#39;)</span>
<span class="s">            print(&#39;-----------&#39;)</span>
<span class="s">            print(repr(pyth_result))</span>
<span class="s">            print(&#39;=========== (end pyth_result)&#39;)</span>
<span class="s">            print(&#39;___________&#39;)</span>
<span class="s">            print(&#39;cyth_result&#39;)</span>
<span class="s">            print(&#39;-----------&#39;)</span>
<span class="s">            print(repr(cyth_result))</span>
<span class="s">            print(&#39;=========== (end cyth_result)&#39;)</span>
<span class="s">            print(&#39;&lt;/FAILED&gt;&#39;)</span>


<span class="s">    {codes}</span>


<span class="s">    def run_all_benchmarks(iterations):</span>
<span class="s">        print(&#39;\n\n&#39;)</span>
<span class="s">        print(&#39;=======================================&#39;)</span>
<span class="s">        print(&#39;[cyth] Run benchmarks for: {py_modname}&#39;)</span>
<span class="s">        with utool.Indenter(&#39; *  &#39;):</span>
<span class="s">            results = []</span>
<span class="s">            {all_benchmarks}</span>
<span class="s">        #sorted_results = sorted(results)</span>
<span class="s">        #sorted_lines = [tup[2] for tup in sorted_results]</span>
<span class="s">        #print(&#39;\n&#39;.join(utool.flatten(sorted_lines)))</span>
<span class="s">        return results</span>


<span class="s">    if __name__ == &#39;__main__&#39;:</span>
<span class="s">        iterations = utool.get_argval((&#39;--iterations&#39;, &#39;-n&#39;), type_=int, default=100)</span>
<span class="s">        run_all_benchmarks(iterations)</span>
<span class="s">    &#39;&#39;&#39;</span>
    <span class="n">bench_text_fmt</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">unindent</span><span class="p">(</span><span class="n">bench_text_fmt_</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bench_text_fmt</span>

</div>
<div class="viewcode-block" id="make_bench_text"><a class="viewcode-back" href="../../cyth.html#cyth.cyth_benchmarks.make_bench_text">[docs]</a><span class="k">def</span> <span class="nf">make_bench_text</span><span class="p">(</span><span class="n">benchmark_codes</span><span class="p">,</span> <span class="n">benchmark_names</span><span class="p">,</span> <span class="n">py_modname</span><span class="p">):</span>
    <span class="c"># TODO: let each function individually specify number</span>
    <span class="n">codes</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n\n\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">benchmark_codes</span><span class="p">)</span>  <span class="c"># NOQA</span>
    <span class="n">list_</span> <span class="o">=</span> <span class="p">[</span><span class="n">utool</span><span class="o">.</span><span class="n">quasiquote</span><span class="p">(</span><span class="s">&#39;results.extend({benchfunc}(iterations))&#39;</span><span class="p">)</span>
             <span class="k">for</span> <span class="n">benchfunc</span> <span class="ow">in</span> <span class="n">benchmark_names</span><span class="p">]</span>
    <span class="n">all_benchmarks</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">list_</span><span class="p">),</span> <span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c"># NOQA</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">()</span>  <span class="c"># NOQA</span>
    <span class="n">bench_text_fmt</span> <span class="o">=</span> <span class="n">get_bench_text_fmt</span><span class="p">()</span>
    <span class="n">bench_text</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">quasiquote</span><span class="p">(</span><span class="n">bench_text_fmt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bench_text</span>

</div>
<div class="viewcode-block" id="parse_benchmarks"><a class="viewcode-back" href="../../cyth.html#cyth.cyth_benchmarks.parse_benchmarks">[docs]</a><span class="k">def</span> <span class="nf">parse_benchmarks</span><span class="p">(</span><span class="n">funcname</span><span class="p">,</span> <span class="n">docstring</span><span class="p">,</span> <span class="n">py_modname</span><span class="p">):</span>
    <span class="n">test_tuples_</span><span class="p">,</span> <span class="n">setup_script_</span> <span class="o">=</span> <span class="n">make_benchmarks</span><span class="p">(</span><span class="n">funcname</span><span class="p">,</span> <span class="n">docstring</span><span class="p">,</span> <span class="n">py_modname</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_tuples_</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">test_tuples</span> <span class="o">=</span> <span class="s">&#39;[]&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">test_tuples</span> <span class="o">=</span> <span class="s">&#39;[</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>  <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">    &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">test_tuples_</span><span class="p">)))</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">    ]&#39;</span>  <span class="c"># NOQA</span>
    <span class="n">setup_script</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">indent</span><span class="p">(</span><span class="n">setup_script_</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>  <span class="c"># NOQA</span>
    <span class="n">benchmark_name</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">quasiquote</span><span class="p">(</span><span class="s">&#39;run_benchmark_{funcname}&#39;</span><span class="p">)</span>
    <span class="c">#test_tuples, setup_script = make_benchmarks(&#39;&#39;&#39;{funcname}&#39;&#39;&#39;, &#39;&#39;&#39;{docstring}&#39;&#39;&#39;)</span>
    <span class="c"># http://en.wikipedia.org/wiki/Relative_change_and_difference</span>
    <span class="n">bench_code_fmt_</span> <span class="o">=</span> <span class="s">r&#39;&#39;&#39;</span>
<span class="s">    def {benchmark_name}(iterations):</span>
<span class="s">        test_tuples = {test_tuples}</span>
<span class="s">        setup_script = textwrap.dedent(&quot;&quot;&quot;</span>
<span class="s">        {setup_script}</span>
<span class="s">        &quot;&quot;&quot;)</span>
<span class="s">        time_line = lambda line: timeit.timeit(stmt=line, setup=setup_script, number=iterations)</span>
<span class="s">        time_pair = lambda (x, y): (time_line(x), time_line(y))</span>
<span class="s">        def print_timing_info(tup):</span>
<span class="s">            from math import log</span>
<span class="s">            test_lines = []</span>
<span class="s">            def test_print(str):</span>
<span class="s">                if not utool.QUIET:</span>
<span class="s">                    print(str)</span>
<span class="s">                test_lines.append(str)</span>
<span class="s">            test_print(&#39;\n---------------&#39;)</span>
<span class="s">            test_print(&#39;[bench] timing {benchmark_name} for </span><span class="si">%d</span><span class="s"> iterations&#39; % (iterations))</span>
<span class="s">            test_print(&#39;[bench] tests:&#39;)</span>
<span class="s">            test_print(&#39;    &#39; + str(tup))</span>
<span class="s">            (pyth_time, cyth_time) = time_pair(tup)</span>
<span class="s">            test_print(&quot;[bench.python] {funcname} time=</span><span class="si">%f</span><span class="s"> seconds&quot; % (pyth_time))</span>
<span class="s">            test_print(&quot;[bench.cython] {funcname} time=</span><span class="si">%f</span><span class="s"> seconds&quot; % (cyth_time))</span>
<span class="s">            time_delta = cyth_time - pyth_time</span>
<span class="s">            #pcnt_change_wrt_pyth = (time_delta / pyth_time) * 100</span>
<span class="s">            #pcnt_change_wrt_cyth = (time_delta / cyth_time) * 100</span>
<span class="s">            pyth_per_cyth = (pyth_time / cyth_time) * 100</span>
<span class="s">            inv_cyth_per_pyth = 1 / (cyth_time / pyth_time) * 100</span>
<span class="s">            nepers  = log(cyth_time / pyth_time)</span>
<span class="s">            if time_delta &lt; 0:</span>
<span class="s">                test_print(&#39;[bench.result] cython was </span><span class="si">%.1f%%</span><span class="s"> of the speed of python&#39; % (inv_cyth_per_pyth,))</span>
<span class="s">                #test_print(&#39;[bench.result] cython was </span><span class="si">%.1f</span><span class="s">x faster&#39; % (-pcnt_change_wrt_pyth,))</span>
<span class="s">                test_print(&#39;[bench.result] cython was </span><span class="si">%.1f</span><span class="s"> nepers faster&#39; % (-nepers,))</span>
<span class="s">                test_print(&#39;[bench.result] cython was faster by </span><span class="si">%f</span><span class="s"> seconds&#39; % -time_delta)</span>
<span class="s">            else:</span>
<span class="s">                test_print(&#39;[bench.result] cython was </span><span class="si">%.1f%%</span><span class="s"> of the speed of python&#39; % (pyth_per_cyth,))</span>
<span class="s">                #test_print(&#39;[bench.result] cython was </span><span class="si">%.1f</span><span class="s">x slower&#39; % (pcnt_change_wrt_pyth,))</span>
<span class="s">                test_print(&#39;[bench.result] cython was </span><span class="si">%.1f</span><span class="s"> nepers slower&#39; % (nepers,))</span>
<span class="s">                test_print(&#39;[bench.result] python was faster by </span><span class="si">%f</span><span class="s"> seconds&#39; % time_delta)</span>
<span class="s">            pyth_call, cyth_call = tup</span>
<span class="s">            run_doctest(pyth_call, cyth_call, setup_script)</span>
<span class="s">            return (pyth_time, cyth_time, test_lines)</span>
<span class="s">        test_results = list(map(print_timing_info, test_tuples))</span>
<span class="s">        # results are lists of (time1, time2, strlist)</span>
<span class="s">        return test_results&#39;&#39;&#39;</span>
    <span class="n">bench_code_fmt</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">unindent</span><span class="p">(</span><span class="n">bench_code_fmt_</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">bench_code</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">quasiquote</span><span class="p">(</span><span class="n">bench_code_fmt</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">benchmark_name</span><span class="p">,</span> <span class="n">bench_code</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="replace_funcalls"><a class="viewcode-back" href="../../cyth.html#cyth.cyth_benchmarks.replace_funcalls">[docs]</a><span class="k">def</span> <span class="nf">replace_funcalls</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">funcname</span><span class="p">,</span> <span class="n">replacement</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; from cyth_script import *  # NOQA</span>
<span class="sd">    &gt;&gt;&gt; replace_funcalls(&#39;foo(5)&#39;, &#39;foo&#39;, &#39;bar&#39;)</span>
<span class="sd">    &#39;bar(5)&#39;</span>
<span class="sd">    &gt;&gt;&gt; replace_funcalls(&#39;foo(5)&#39;, &#39;bar&#39;, &#39;baz&#39;)</span>
<span class="sd">    &#39;foo(5)&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c"># FIXME: !!!</span>
    <span class="c"># http://docs.cython.org/src/userguide/wrapping_CPlusPlus.html#nested-class-declarations</span>
    <span class="c"># C++ allows nested class declaration. Class declarations can also be nested in Cython:</span>
    <span class="c"># Note that the nested class is declared with a cppclass but without a cdef.</span>
    <span class="k">class</span> <span class="nc">FunctioncallReplacer</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">NodeTransformer</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">visit_Call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">funcname</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">replacement</span>
            <span class="k">return</span> <span class="n">node</span>
    <span class="n">generator</span> <span class="o">=</span> <span class="n">astor</span><span class="o">.</span><span class="n">codegen</span><span class="o">.</span><span class="n">SourceGenerator</span><span class="p">(</span><span class="s">&#39; &#39;</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
    <span class="n">generator</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">FunctioncallReplacer</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)))</span>
    <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">generator</span><span class="o">.</span><span class="n">result</span><span class="p">)</span>
    <span class="c">#return ast.dump(tree)</span>

</div>
<div class="viewcode-block" id="parse_doctest_examples"><a class="viewcode-back" href="../../cyth.html#cyth.cyth_benchmarks.parse_doctest_examples">[docs]</a><span class="k">def</span> <span class="nf">parse_doctest_examples</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
    <span class="c"># parse list of docstrings</span>
    <span class="n">comment_iter</span> <span class="o">=</span> <span class="n">doctest</span><span class="o">.</span><span class="n">DocTestParser</span><span class="p">()</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="c"># remove any non-doctests</span>
    <span class="n">example_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">comment_iter</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">doctest</span><span class="o">.</span><span class="n">Example</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">example_list</span>

</div>
<div class="viewcode-block" id="get_benchline"><a class="viewcode-back" href="../../cyth.html#cyth.cyth_benchmarks.get_benchline">[docs]</a><span class="k">def</span> <span class="nf">get_benchline</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">funcname</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns the  from a doctest source &quot;&quot;&quot;</span>
    <span class="n">pt</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">src</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Module</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">body</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="n">stmt</span> <span class="o">=</span> <span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">Expr</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Assign</span><span class="p">)):</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">stmt</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">funcname</span><span class="p">:</span>
            <span class="n">benchline</span> <span class="o">=</span> <span class="n">cyth_helpers</span><span class="o">.</span><span class="n">ast_to_sourcecode</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">benchline</span>

</div>
<div class="viewcode-block" id="make_benchmarks"><a class="viewcode-back" href="../../cyth.html#cyth.cyth_benchmarks.make_benchmarks">[docs]</a><span class="k">def</span> <span class="nf">make_benchmarks</span><span class="p">(</span><span class="n">funcname</span><span class="p">,</span> <span class="n">docstring</span><span class="p">,</span> <span class="n">py_modname</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; from cyth.cyth_script import *  # NOQA</span>
<span class="sd">    &gt;&gt;&gt; funcname = &#39;replace_funcalls&#39;</span>
<span class="sd">    &gt;&gt;&gt; docstring = replace_funcalls.func_doc</span>
<span class="sd">    &gt;&gt;&gt; py_modname = &#39;cyth.cyth_script&#39;</span>
<span class="sd">    &gt;&gt;&gt; benchmark_list = list(make_benchmarks(funcname, docstring, py_modname))</span>
<span class="sd">    &gt;&gt;&gt; print(benchmark_list)</span>
<span class="sd">    [[(&quot;replace_funcalls(&#39;foo(5)&#39;, &#39;foo&#39;, &#39;bar&#39;)&quot;, &quot;_replace_funcalls_cyth(&#39;foo(5)&#39;, &#39;foo&#39;, &#39;bar&#39;)&quot;), (&quot;replace_funcalls(&#39;foo(5)&#39;, &#39;bar&#39;, &#39;baz&#39;)&quot;, &quot;_replace_funcalls_cyth(&#39;foo(5)&#39;, &#39;bar&#39;, &#39;baz&#39;)&quot;)], &quot;from cyth.cyth_script import _replace_funcalls_cyth\nfrom cyth_script import *  # NOQA\nreplace_funcalls(&#39;foo(5)&#39;, &#39;foo&#39;, &#39;bar&#39;)\nreplace_funcalls(&#39;foo(5)&#39;, &#39;bar&#39;, &#39;baz&#39;)\n&quot;]</span>

<span class="sd">    #&gt;&gt;&gt; output = [((x.source, x.want), y.source, y.want) for x, y in benchmark_list]</span>
<span class="sd">    #&gt;&gt;&gt; print(utool.hashstr(repr(output)))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">doctest_examples</span> <span class="o">=</span> <span class="n">parse_doctest_examples</span><span class="p">(</span><span class="n">docstring</span><span class="p">)</span>
    <span class="n">test_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cyth_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">setup_lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cyth_funcname</span> <span class="o">=</span> <span class="n">cyth_helpers</span><span class="o">.</span><span class="n">get_cyth_name</span><span class="p">(</span><span class="n">funcname</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">example</span> <span class="ow">in</span> <span class="n">doctest_examples</span><span class="p">:</span>
        <span class="n">benchline</span> <span class="o">=</span> <span class="n">get_benchline</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">funcname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">benchline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">test_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">benchline</span><span class="p">)</span>
            <span class="n">cyth_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">replace_funcalls</span><span class="p">(</span><span class="n">benchline</span><span class="p">,</span> <span class="n">funcname</span><span class="p">,</span> <span class="n">cyth_funcname</span><span class="p">))</span>
            <span class="n">setup_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">setup_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">example</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
    <span class="n">test_tuples</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">test_lines</span><span class="p">,</span> <span class="n">cyth_lines</span><span class="p">))</span>
    <span class="n">setup_script</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">unindent</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">setup_lines</span><span class="p">))</span>
    <span class="c">#modname = &#39;vtool.keypoint&#39;</span>
    <span class="n">setup_script</span> <span class="o">=</span> <span class="s">&#39;from </span><span class="si">%s</span><span class="s"> import </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">py_modname</span><span class="p">,</span> <span class="n">cyth_funcname</span><span class="p">,)</span> <span class="o">+</span> <span class="n">setup_script</span>
    <span class="k">return</span> <span class="n">test_tuples</span><span class="p">,</span> <span class="n">setup_script</span>

</div>
<div class="viewcode-block" id="build_runbench_shell_text"><a class="viewcode-back" href="../../cyth.html#cyth.cyth_benchmarks.build_runbench_shell_text">[docs]</a><span class="k">def</span> <span class="nf">build_runbench_shell_text</span><span class="p">(</span><span class="n">cy_bench_list</span><span class="p">):</span>
    <span class="c"># write script to run all cyth benchmarks</span>
    <span class="n">cmd_list</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;python &#39;</span> <span class="o">+</span> <span class="n">bench</span> <span class="o">+</span> <span class="s">&#39; $*&#39;</span>
                <span class="k">for</span> <span class="n">bench</span> <span class="ow">in</span> <span class="n">cy_bench_list</span><span class="p">]</span>
    <span class="n">runbench_text</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;#!/bin/bash&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">cmd_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">runbench_text</span>

</div>
<div class="viewcode-block" id="build_runbench_pyth_text"><a class="viewcode-back" href="../../cyth.html#cyth.cyth_benchmarks.build_runbench_pyth_text">[docs]</a><span class="k">def</span> <span class="nf">build_runbench_pyth_text</span><span class="p">(</span><span class="n">cy_bench_list</span><span class="p">):</span>
    <span class="c"># write script to run all cyth benchmarks</span>
    <span class="n">runbench_pytext_fmt_</span> <span class="o">=</span> <span class="s">r&#39;&#39;&#39;</span>
<span class="s">    #!/usr/bin/env python</span>
<span class="s">    &quot; Autogenerated by cyth on {timestamp} &quot;</span>
<span class="s">    from __future__ import absolute_import, division, print_function</span>
<span class="s">    import utool</span>
<span class="s">    {bench_import_text}</span>

<span class="s">    SORTBY = utool.get_argval(&#39;--sortby&#39;, str, &#39;python&#39;)</span>

<span class="s">    if __name__ == &#39;__main__&#39;:</span>
<span class="s">        all_results = []</span>
<span class="s">        iterations = utool.get_argval((&#39;--iterations&#39;, &#39;-n&#39;), type_=int, default=100)</span>

<span class="s">        # Run the benchmarks</span>
<span class="s">        {bench_runline_text}</span>
<span class="s">        # Sort by chosen field</span>
<span class="s">        sortable_fields = [&#39;python&#39;, &#39;cython&#39;]</span>
<span class="s">        sortx = sortable_fields.index(SORTBY)</span>
<span class="s">        sorted_allresults = sorted(all_results, key=lambda tup: tup[sortx])</span>
<span class="s">        sorted_lines = [tup[2] for tup in sorted_allresults]</span>
<span class="s">        # Report sorted results</span>
<span class="s">        print(&#39;\n\n&#39;)</span>
<span class="s">        print(&#39;==================================&#39;)</span>
<span class="s">        print(&#39;Aggregating all benchmarks results&#39;)</span>
<span class="s">        print(&#39;==================================&#39;)</span>
<span class="s">        print(&#39;\n&#39;)</span>
<span class="s">        print(&#39;sorting by </span><span class="si">%s</span><span class="s">&#39; </span><span class="si">% s</span><span class="s">ortable_fields[sortx])</span>
<span class="s">        print(&#39;\n&#39;.join(utool.flatten(sorted_lines)))</span>
<span class="s">    &#39;&#39;&#39;</span>
    <span class="n">runbench_pytext_fmt</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">unindent</span><span class="p">(</span><span class="n">runbench_pytext_fmt_</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">relpath</span><span class="p">,</span> <span class="n">splitext</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="k">def</span> <span class="nf">bench_fpath_to_modname</span><span class="p">(</span><span class="n">bench</span><span class="p">):</span>
        <span class="n">bench_upath</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">unixpath</span><span class="p">(</span><span class="n">bench</span><span class="p">)</span>
        <span class="n">bench_relpath</span> <span class="o">=</span> <span class="n">relpath</span><span class="p">(</span><span class="n">bench_upath</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="n">bench_relname</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">splitext</span><span class="p">(</span><span class="n">bench_relpath</span><span class="p">)</span>
        <span class="n">bench_modname</span> <span class="o">=</span> <span class="n">bench_relname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bench_modname</span>

    <span class="n">bench_modnames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">bench_fpath_to_modname</span><span class="p">,</span> <span class="n">cy_bench_list</span><span class="p">))</span>

    <span class="n">bench_imports</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;import &#39;</span> <span class="o">+</span> <span class="n">bench_modname</span> <span class="k">for</span> <span class="n">bench_modname</span> <span class="ow">in</span> <span class="n">bench_modnames</span><span class="p">]</span>
    <span class="n">runline_fmt</span> <span class="o">=</span> <span class="s">&#39;all_results.extend({bench_modname}.run_all_benchmarks(iterations))&#39;</span>
    <span class="n">bench_runlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">runline_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bench_modname</span><span class="o">=</span><span class="n">bench_modname</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">bench_modname</span> <span class="ow">in</span> <span class="n">bench_modnames</span><span class="p">]</span>
    <span class="n">bench_import_text</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bench_imports</span><span class="p">)</span>
    <span class="n">bench_runline_text</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">    &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bench_runlines</span><span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">utool</span><span class="o">.</span><span class="n">get_timestamp</span><span class="p">()</span>  <span class="c"># NOQA</span>
    <span class="n">runbench_pytext</span> <span class="o">=</span> <span class="n">runbench_pytext_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">timestamp</span><span class="o">=</span><span class="n">timestamp</span><span class="p">,</span>
                                                 <span class="n">bench_runline_text</span><span class="o">=</span><span class="n">bench_runline_text</span><span class="p">,</span>
                                                 <span class="n">bench_import_text</span><span class="o">=</span><span class="n">bench_import_text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">runbench_pytext</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">cyth 1.0.0.dev1 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2014, Jon Crall.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>